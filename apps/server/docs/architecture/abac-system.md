# ABAC æƒé™æ§åˆ¶ç³»ç»Ÿ

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

åŸºäº CASL åº“å®ç°çš„ ABAC (Attribute-Based Access Control) æƒé™æ§åˆ¶ç³»ç»Ÿï¼Œæ”¯æŒç»†ç²’åº¦çš„æƒé™ç®¡ç†ã€‚

## ğŸ‘¥ ç”¨æˆ·è§’è‰²ä½“ç³»

### 4ç§ç”¨æˆ·è§’è‰²

| è§’è‰² | è‹±æ–‡å | æƒé™èŒƒå›´ | ä½¿ç”¨åœºæ™¯ |
|------|--------|----------|----------|
| **è¶…çº§ç®¡ç†å‘˜** | `super_admin` | ç³»ç»Ÿæ‰€æœ‰æƒé™ | ç³»ç»Ÿç»´æŠ¤ã€æœ€é«˜æƒé™ |
| **ç®¡ç†å‘˜** | `admin` | ç”¨æˆ·ã€è§’è‰²ã€å†…å®¹ç®¡ç† | å¹³å°æ—¥å¸¸ç®¡ç† |
| **å›¢é˜Ÿå¼€å‘è€…** | `team_developer` | æ–‡æ¡£ã€çŸ¥è¯†åº“ç®¡ç† | å†…å®¹åˆ›å»ºå’Œç»´æŠ¤ |
| **è®¿å®¢** | `visitor` | åªè¯»æƒé™ | å†…å®¹æŸ¥çœ‹ |

## ğŸ“‹ æƒé™çŸ©é˜µ

### æ“ä½œç±»å‹ (Action)
```typescript
CREATE  // åˆ›å»º
READ    // è¯»å–
UPDATE  // æ›´æ–°  
DELETE  // åˆ é™¤
MANAGE  // ç®¡ç†ï¼ˆåŒ…å«æ‰€æœ‰æ“ä½œï¼‰
```

### èµ„æºç±»å‹ (Subject)
```typescript
USER           // ç”¨æˆ·ç®¡ç†
ROLE           // è§’è‰²ç®¡ç†
PERMISSION     // æƒé™ç®¡ç†
DOCUMENT       // æ–‡æ¡£ç®¡ç†
KNOWLEDGE_BASE // çŸ¥è¯†åº“ç®¡ç†
SYSTEM         // ç³»ç»Ÿç®¡ç†
ALL            // æ‰€æœ‰èµ„æº
```

### è¯¦ç»†æƒé™åˆ†é…

#### è¶…çº§ç®¡ç†å‘˜ (super_admin)
- âœ… `manage:all` - æ‹¥æœ‰ç³»ç»Ÿæ‰€æœ‰æƒé™

#### ç®¡ç†å‘˜ (admin)
- âœ… `manage:user` - ç®¡ç†ç”¨æˆ·
- âœ… `manage:role` - ç®¡ç†è§’è‰²
- âœ… `manage:knowledge_base` - ç®¡ç†çŸ¥è¯†åº“
- âœ… `manage:document` - ç®¡ç†æ–‡æ¡£
- âœ… `read:system` - æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯

#### å›¢é˜Ÿå¼€å‘è€… (team_developer)
- âœ… `manage:document` - ç®¡ç†æ–‡æ¡£
- âœ… `manage:knowledge_base` - ç®¡ç†çŸ¥è¯†åº“
- âœ… `read:user` - æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯

#### è®¿å®¢ (visitor)
- âœ… `read:document` - æŸ¥çœ‹æ–‡æ¡£
- âœ… `read:knowledge_base` - æŸ¥çœ‹çŸ¥è¯†åº“

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒç»„ä»¶
- **CASL AbilityFactory** - æƒé™èƒ½åŠ›å·¥å‚
- **PoliciesGuard** - æƒé™å®ˆå«
- **@RequirePermission** - æƒé™è£…é¥°å™¨
- **Permission Entity** - æƒé™å®ä½“

### æƒé™æ£€æŸ¥æµç¨‹
1. è¯·æ±‚åˆ°è¾¾æ§åˆ¶å™¨
2. `PoliciesGuard` æ‹¦æˆªè¯·æ±‚
3. è¯»å– `@RequirePermission` è£…é¥°å™¨é…ç½®
4. é€šè¿‡ `CaslAbilityFactory` æ£€æŸ¥ç”¨æˆ·æƒé™
5. å…è®¸æˆ–æ‹’ç»è®¿é—®

## ğŸš€ ä½¿ç”¨æ–¹å¼

### æ§åˆ¶å™¨æƒé™æ§åˆ¶
```typescript
@Controller('admin/users')
@UseGuards(JwtAuthGuard, PoliciesGuard)
export class UserAdminController {
  
  // ç®¡ç†å‘˜ä»¥ä¸Šå¯è®¿é—®
  @Get()
  @RequirePermission(Action.READ, Subject.USER)
  async findAll() { ... }
  
  // åªæœ‰ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯è®¿é—®
  @Post()
  @RequirePermission(Action.MANAGE, Subject.USER)
  async create() { ... }
}
```

### å‰ç«¯æƒé™æ£€æŸ¥
```typescript
// æ£€æŸ¥æ˜¯å¦æœ‰æƒé™
const canManageUsers = usePermission('manage', 'user');

// æ¡ä»¶æ¸²æŸ“
{canManageUsers && <UserManageButton />}
```

## ğŸ”„ æ‰©å±•æ€§è®¾è®¡

### å½“å‰é˜¶æ®µï¼šç®€åŒ–æƒé™
```typescript
// æƒé™å®ä½“ä¸­ conditions å­—æ®µä¿æŒä¸º undefined
{
  action: 'read',
  subject: 'document',
  conditions: undefined  // é¢„ç•™æ‰©å±•å­—æ®µ
}
```

### æœªæ¥æ‰©å±•ï¼šæ¡ä»¶æƒé™
```typescript
// å¯ä»¥æ‰©å±•ä¸ºå¤æ‚çš„æ¡ä»¶æƒé™
{
  action: 'read',
  subject: 'document',
  conditions: {
    authorId: 'currentUserId',     // åªèƒ½è¯»å–è‡ªå·±çš„æ–‡æ¡£
    department: 'currentUserDept', // åªèƒ½è¯»å–æœ¬éƒ¨é—¨æ–‡æ¡£
    status: 'published'            // åªèƒ½è¯»å–å·²å‘å¸ƒæ–‡æ¡£
  }
}
```

## ğŸ“Š è§’è‰²åˆå§‹åŒ–

### è‡ªåŠ¨åˆå§‹åŒ–
ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºé¢„è®¾è§’è‰²å’Œæƒé™ï¼š

```typescript
// è°ƒç”¨åˆå§‹åŒ–æœåŠ¡
await roleInitService.initializeRoles();
```

### æ‰‹åŠ¨ç®¡ç†
é€šè¿‡ç®¡ç†æ¥å£è¿›è¡Œè§’è‰²ç®¡ç†ï¼š

```bash
# åˆå§‹åŒ–è§’è‰²
POST /admin/role-init/initialize

# æŸ¥çœ‹è§’è‰²æ¦‚è§ˆ  
GET /admin/role-init/overview

# é‡ç½®è§’è‰²ï¼ˆå±é™©æ“ä½œï¼‰
POST /admin/role-init/reset
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### æƒé™éš”ç¦»
- ä¸åŒè§’è‰²åªèƒ½è®¿é—®æˆæƒçš„èµ„æº
- æƒé™æ£€æŸ¥åœ¨æ¯ä¸ªè¯·æ±‚ä¸­è¿›è¡Œ
- æ”¯æŒç»†ç²’åº¦çš„æ“ä½œæ§åˆ¶

### æ‰©å±•å®‰å…¨
- é¢„ç•™ `conditions` å­—æ®µæ”¯æŒå¤æ‚æƒé™
- æ”¯æŒå­—æ®µçº§æƒé™æ§åˆ¶
- æ”¯æŒæ‹’ç»æƒé™ï¼ˆinvertedï¼‰

## ğŸ“ˆ æœ€ä½³å®è·µ

### æƒé™è®¾è®¡åŸåˆ™
1. **æœ€å°æƒé™åŸåˆ™** - ç”¨æˆ·åªè·å¾—å¿…éœ€çš„æƒé™
2. **è§’è‰²åˆ†ç¦»** - ä¸åŒè§’è‰²èŒè´£æ˜ç¡®
3. **æƒé™ç»§æ‰¿** - é«˜çº§è§’è‰²åŒ…å«ä½çº§è§’è‰²æƒé™
4. **æ‰©å±•é¢„ç•™** - ä¸ºæœªæ¥å¤æ‚æƒé™é¢„ç•™ç©ºé—´

### ä½¿ç”¨å»ºè®®
1. **ä¼˜å…ˆä½¿ç”¨é¢„è®¾è§’è‰²** - æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯éœ€æ±‚
2. **è°¨æ…ä½¿ç”¨å¤æ‚æƒé™** - é¿å…è¿‡åº¦è®¾è®¡
3. **å®šæœŸæƒé™å®¡è®¡** - ç¡®ä¿æƒé™åˆ†é…åˆç†
4. **æ–‡æ¡£åŒæ­¥æ›´æ–°** - æƒé™å˜æ›´åŠæ—¶æ›´æ–°æ–‡æ¡£
